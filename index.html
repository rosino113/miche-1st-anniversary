<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸçš„å‡çš„ï¼Ÿï¼æˆ‘æ¥å½“PDï¼Ÿ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        :root {
            --main-blue: #87CEEB;
            --deep-blue: #4682B4;
            --light-blue: #E0F7FA;
            --bg-color: #F0F8FF;
            --chat-bg: #E6E6E6;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#dbe9f4 15%, transparent 16%), radial-gradient(#dbe9f4 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
        }

        .screen {
            width: 100%; max-width: 450px; height: 95vh;
            background: white; border-radius: 25px;
            box-shadow: 0 15px 35px rgba(70, 130, 180, 0.2);
            position: relative; display: none;
            flex-direction: column; overflow: hidden;
            border: 6px solid var(--main-blue);
        }

        /* --- å…¨å±€éŸ³ä¹å›¾æ ‡ --- */
        #global-music-control {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
        }
        #music-icon {
            width: 36px; height: 36px; cursor: pointer;
            background: white; border: 2px solid var(--deep-blue);
            border-radius: 50%; padding: 5px; 
            color: var(--deep-blue); display: flex; align-items: center; justify-content: center; 
            font-size: 1.2em; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        #music-icon:active { transform: translateY(2px); box-shadow: none; }
        
        #music-menu {
            position: absolute; top: 50px; right: 0; 
            background: white; border-radius: 10px; padding: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; 
            flex-direction: column; gap: 5px;
            border: 2px solid var(--main-blue); width: 150px;
        }
        .music-item { padding: 8px; background: #f9f9f9; border-radius: 5px; cursor: pointer; font-size: 0.85em; text-align: left; }
        .music-item.locked { color: #aaa; cursor: not-allowed; }
        .music-item.active { background: var(--main-blue); color: white; font-weight: bold; }

        /* --- 1. ä¸»èœå• --- */
        #start-screen {
            display: flex;
            background: linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%);
            align-items: center; justify-content: center; text-align: center;
            position: relative; overflow: hidden;
        }
        .cloud { position: absolute; background: rgba(255,255,255,0.3); border-radius: 50px; animation: floatCloud 10s infinite linear; }
        @keyframes floatCloud { from {left: -100px;} to {left: 100%;} }
        .title-box h1 { color: white; font-size: 2.8em; margin-bottom: 30px; text-shadow: 4px 4px 0px var(--deep-blue); line-height: 1.2; transform: rotate(-3deg); }
        .menu-btn {
            background: white; color: var(--deep-blue); border: none; padding: 12px 30px; font-size: 1.2em; border-radius: 30px;
            margin: 10px; cursor: pointer; box-shadow: 0 5px 0 #b0e0e6; font-family: inherit; width: 200px; font-weight: bold;
        }
        .menu-btn:active { transform: translateY(5px); box-shadow: none; }

        /* --- 2. èŠå¤©ç•Œé¢ --- */
        #chat-screen { background: var(--chat-bg); }
        .chat-list { padding: 10px; overflow-y: auto; flex: 1; }
        .contact-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; }
        #chat-content { flex: 1; padding: 15px; overflow-y: auto; display: none; flex-direction: column; }
        .message { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .message.me { flex-direction: row-reverse; }
        .bubble { padding: 10px 15px; border-radius: 10px; max-width: 70%; font-size: 0.95em; line-height: 1.4; box-shadow: 0 2px 2px rgba(0,0,0,0.05);}
        .message.her .bubble { background: white; margin-left: 10px; border-top-left-radius: 0; }
        .message.me .bubble { background: var(--main-blue); color: white; margin-right: 10px; border-top-right-radius: 0; }
        .chat-options { padding: 20px; background: #f7f7f7; display: none; justify-content: space-around; }

        /* --- 3. æ¸¸æˆä¸»ç•Œé¢ --- */
        #header { padding: 15px; background: white; color: var(--deep-blue); text-align: center; position: relative; z-index: 20; border-bottom: 2px dashed var(--main-blue); }
        #main-area {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; 
            background: white; overflow: hidden; margin: 10px; border: 3px solid #eee; border-radius: 15px;
        }
        .sticker { position: absolute; font-size: 2em; opacity: 0.8; pointer-events: none; z-index: 5; }
        .sticker-tl { top: 10px; left: 10px; transform: rotate(-15deg); }
        .sticker-tr { top: 10px; right: 10px; transform: rotate(15deg); }
        .sticker-bl { bottom: 10px; left: 10px; transform: rotate(10deg); }
        .sticker-br { bottom: 10px; right: 10px; transform: rotate(-10deg); font-size: 3em; opacity: 0.2; }
        #character { width: 250px; height: 250px; image-rendering: pixelated; transition: all 0.5s; z-index: 10; position: relative; }
        .evolving { filter: brightness(1.5) blur(2px); transform: scale(1.1); }
        #game-bubble {
            position: absolute; top: 10px; background: white; padding: 10px 15px; border-radius: 15px; 
            border: 2px solid var(--deep-blue); max-width: 80%; text-align: center; opacity: 0; transition: opacity 0.3s; z-index: 15;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        #center-notification {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px;
            border: 4px solid var(--deep-blue); text-align: center; color: var(--deep-blue);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; display: none; opacity: 0;
            transition: opacity 0.3s; pointer-events: none; width: 75%; font-size: 1.2em;
        }
        #controls { padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: var(--light-blue); }
        .game-btn { 
            background: white; border: none; border-radius: 15px; padding: 12px 2px;
            color: var(--deep-blue); font-family: inherit; cursor: pointer; font-size: 0.9em; 
            box-shadow: 0 4px 0 #b0c4de; transition: transform 0.1s;
        }
        .game-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #b0c4de; }
        #progress-container { width: 80%; margin: 5px auto; height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #87CEEB, #4682B4); border-radius: 10px; transition: width 0.3s ease; }

        /* --- 4. å†™ä¿¡ç•Œé¢ --- */
        #editor-screen { background: #fffaf0; }
        #wish-input { width: 80%; height: 50%; margin: 20px auto; padding: 20px; border: 2px dashed var(--main-blue); border-radius: 10px; background:white; font-family: inherit; font-size: 1.1em; color: var(--deep-blue);}

        /* --- 5. æœ€ç»ˆæ¡Œé¢ç»“å±€ --- */
        #ending-table-screen {
            background: #fdf5e6; /* ç±³è‰²æ¡Œé¢ */
            display: none; align-items: center; justify-content: center;
            position: relative; cursor: pointer; /* æç¤ºå¯ç‚¹å‡» */
        }
        #ending-table-screen::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 2px, transparent 2px, transparent 10px);
            pointer-events: none;
        }
        
        .table-item {
            position: absolute; opacity: 0; transform: scale(1.5) rotate(10deg);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .table-item.drop { opacity: 1; transform: scale(1) rotate(var(--r)); }

        .final-envelope { width: 220px; height: 140px; background: var(--main-blue); border-radius: 5px; z-index: 1; }
        .final-sticker { width: 80px; z-index: 2; image-rendering: pixelated; }
        .final-polaroid {
            padding: 10px 10px 40px 10px; background: white; width: 160px; z-index: 5;
            transform: rotate(-5deg); text-align: center;
        }
        .final-polaroid img { width: 100%; border-radius: 2px; }

        /* æç¤ºå°ç®­å¤´ */
        #click-hint-arrow {
            position: absolute; top: 70%; left: 50%; transform: translateX(-50%);
            font-size: 2em; color: var(--deep-blue); z-index: 30;
            animation: bounce 1s infinite; display: none; pointer-events: none;
            text-shadow: 0 2px 5px rgba(255,255,255,0.8);
        }
        @keyframes bounce { 0%, 100% {transform:translate(-50%, 0);} 50% {transform:translate(-50%, 10px);} }

        /* æ¨¡ç³Šå±‚ä¸æ–‡å­— */
        #ending-blur-layer {
            position: absolute; top:0; left:0; width:100%; height:100%;
            pointer-events: none; transition: backdrop-filter 1s; z-index: 10;
        }
        .blur-active { backdrop-filter: blur(8px); background: rgba(255,255,255,0.4); }

        #final-text-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 40; opacity: 0; transition: opacity 2s; width: 100%;
        }
        #final-text-container h1 {
            font-size: 2.2em; color: var(--deep-blue);
            text-shadow: 2px 2px 0 white, 0 0 20px white;
            margin-bottom: 10px;
        }
        .credits {
            font-size: 0.9em; color: #666; font-family: monospace; 
            background: white; padding: 5px 15px; border-radius: 20px; 
            display: inline-block; margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body>

    <audio id="bgm-player" loop></audio>

    <div id="global-music-control" style="display:none;">
        <div id="music-icon" onclick="toggleMusicMenu()">ğŸµ</div>
        <div id="music-menu">
            <div class="music-item active" onclick="playMusic('default', this)">ğŸ¹ é»˜è®¤æ›²</div>
            <div class="music-item locked" id="track-s2" onclick="playMusic('skin', this)">ğŸ”’ Under My Skin</div>
            <div class="music-item locked" id="track-s3" onclick="playMusic('boss', this)">ğŸ”’ BOSS</div>
            <div class="music-item locked" id="track-s4" onclick="playMusic('bbb', this)">ğŸ”’ B.B.B</div>
            <div class="music-item locked" id="track-s5" onclick="playMusic('papa', this)">ğŸ”’ PAPARAZZI ARRIVE</div>
        </div>
    </div>

    <div id="start-screen" class="screen" style="display: flex;">
        <div class="cloud" style="width: 80px; height: 30px; top: 10%;"></div>
        <div class="cloud" style="width: 120px; height: 40px; top: 25%; animation-duration: 15s;"></div>
        
        <div class="title-box">
            <h1>çœŸçš„å‡çš„ï¼Ÿï¼<br>æˆ‘æ¥å½“PDï¼Ÿ</h1>
            <button class="menu-btn" onclick="startChat()">ğŸ¬ å¼€å§‹å½“PD</button>
            <button class="menu-btn" onclick="viewLetters()">ğŸ’Œ æŸ¥çœ‹ä¿¡ä»¶</button>
        </div>
    </div>

    <div id="letters-list-screen" class="screen" style="background: #F0F8FF; padding: 20px; overflow-y: auto;">
        <h2 style="text-align: center; color: var(--deep-blue);">ğŸ—‚ï¸ é€å‡ºçš„ä¿¡</h2>
        <div id="letters-container"></div>
        <button class="menu-btn" style="margin: 20px auto; width: 120px;" onclick="goHome()">è¿”å›</button>
    </div>

    <div id="chat-screen" class="screen">
        <div class="chat-header" style="background:#f7f7f7; padding:15px; border-bottom:1px solid #ddd; text-align:center; font-weight:bold;">MiChat (99+)</div>
        <div id="contact-list" class="chat-list">
            <div class="contact-item" onclick="openChat()">
                <img src="images/avatar_miche.jpg" style="width:50px; height:50px; border-radius:10px; margin-right:15px; background:#ddd; object-fit:cover;" onerror="this.src='https://via.placeholder.com/50'">
                <div style="flex:1;">
                    <div style="font-weight:bold;">Miche (çƒ§çƒ§)</div>
                    <div style="font-size:0.8em; color:gray;">[éœ‡åŠ¨] å®å®ï¼ï¼æ•‘å‘½ï¼ï¼</div>
                </div>
                <div style="background:red; color:white; border-radius:50%; padding:2px 8px; font-size:0.8em;">1</div>
            </div>
            <div class="contact-item">
                <img src="images/avatar_other.jpg" style="width:50px; height:50px; border-radius:10px; margin-right:15px; background:#ddd;" onerror="this.src='https://via.placeholder.com/50'">
                <div><div style="font-weight:bold;">å¤–å–</div><div style="font-size:0.8em; color:gray;">å¤–å–æ”¾é—¨å£äº†</div></div>
            </div>
        </div>
        <div id="chat-content"></div>
        <div id="chat-options" class="chat-options">
            <button class="game-btn" onclick="handleChatChoice(false)">å•Šâ€¦â€¦æˆ‘ä¸å¹²â€¦â€¦</button>
            <button class="game-btn" style="background:var(--main-blue); color:white; box-shadow: 0 4px 0 #4682B4;" onclick="handleChatChoice(true)">å¥½ï¼å¼€å§‹å§ï¼</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="header">
            <div id="stage-title" style="font-size: 1.5em; font-weight: bold;">Stage 1</div>
            <div id="progress-container"><div id="progress-bar"></div></div>
        </div>
        
        <div id="main-area">
            <div class="sticker sticker-tl">â˜ï¸</div>
            <div class="sticker sticker-tr">âœ¨</div>
            <div class="sticker sticker-bl">ğŸµ</div>
            <div class="sticker sticker-br">A2O</div>
            
            <div id="game-bubble"></div>
            <div id="center-notification"></div>
            <img id="character" src="images/s1_idle.gif" alt="Miche">
        </div>
        
        <div id="controls"></div>
    </div>

    <div id="editor-screen" class="screen">
        <div style="padding: 20px; text-align: center;"><h2 style="color: var(--deep-blue);">æ­å–œè·Ÿçƒ§çƒ§ä¸€èµ·é€šå…³ï¼æœ‰ä»€ä¹ˆè¯æƒ³å¯¹çƒ§çƒ§è¯´å— âœï¸</h2></div>
        <div style="padding:10px; display:flex; gap:10px; justify-content:center;">
            <button class="game-btn" style="width:auto; padding:5px 15px;" onclick="document.getElementById('wish-input').value+='ğŸ©µ'">ğŸ©µ</button>
            <button class="game-btn" style="width:auto; padding:5px 15px;" onclick="document.getElementById('wish-input').value+='ğŸ¥º'">ğŸ¥º</button>
            <button class="game-btn" style="width:auto; padding:5px 15px;" onclick="document.getElementById('wish-input').value+='ğŸ‚'">ğŸ‚</button>
        </div>
        <textarea id="wish-input" placeholder="äº²çˆ±çš„çƒ§çƒ§..."></textarea>
        <button class="menu-btn" style="margin: 0 auto;" onclick="runEndingSequence()">å‘é€ä¿¡ä»¶ âœ‰ï¸</button>
    </div>

    <div id="ending-table-screen" class="screen" onclick="triggerFinalReveal()">
        <div id="ending-blur-layer"></div>
        <div id="table-items-container" style="width:100%; height:100%; position:relative;"></div>
        
        <div id="click-hint-arrow">ğŸ‘†</div>

        <div id="final-text-container">
            <h1>é™ˆä½³ä»ª<br>å‡ºé“ä¸€å‘¨å¹´å¿«ä¹ï¼<br>ğŸ‰</h1>
            <div class="credits">@DDDD & Gemini</div>
            <br><br>
            <button class="menu-btn" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

<script>
    const CLICK_TARGET = 10;
    const stages = [
        {
            title: "Stage 1",
            levelUpText: "æ­å–œï¼è¿ˆå‡ºäº†æ¢¦æƒ³çš„ç¬¬ä¸€æ­¥ï¼âœ¨",
            songId: null,
            idleImg: "images/s1_idle.gif",
            idleTexts: ["å‘¼... ä»Šå¤©çš„èˆè¹ˆåŠ¨ä½œæœ‰æ²¡æœ‰è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼ŸğŸ¥º", "ä¸ºäº†æ¢¦æƒ³ï¼Œæˆ‘ä¼šåšæŒçš„ï¼ğŸ’ª", "é‡æ¥ï¼"],
            actions: [
                { name: "ğŸ–ï¸ æ‘¸æ‘¸å¤´", img: "images/s1_pat.gif", text: "è¢«æ‘¸å¤´äº†â„(â„ â„â€¢â„Ï‰â„â€¢â„ â„)â„" },
                { name: "ğŸ¤ ç»ƒå”±æ­Œ", img: "images/s1_sing.gif", text: "å’³å’³... è¿™é¦–æ­Œåªå”±ç»™ä½ å¬å“¦~ğŸµ" },
                { name: "ğŸ¦ åƒå†°æ·‡æ·‹", img: "images/s1_icecream.gif", text: "å“‡ï¼æ˜¯å†°æ·‡æ·‹ï¼åƒä¸€å£... å°±ä¸€å£... ğŸ‘‰ğŸ‘ˆ" }
            ]
        },
        {
            title: "Stage 2",
            levelUpText: "è§£é”æ–°æ­Œï¼šUnder My Skin ğŸ•¶ï¸",
            songId: "track-s2",
            idleImg: "images/s2_idle.gif",
            idleTexts: ["å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯A2O MAYçš„é™ˆä½³ä»ªMicheï¼çƒ§~ä¸€ç±³è¾¾ï¼ğŸ˜ˆ", "ç»ˆäºè§åˆ°ä½ ä»¬äº†ï¼ğŸ¥º", "çœ‹åˆ°å°ä¸‹çš„ä½ ä»¬ï¼Œæˆ‘å°±ä¸€ç‚¹ä¹Ÿä¸ç´§å¼ å•¦ğŸ©µ"],
            actions: [
                { name: "ğŸ¤ æ¥å—é‡‡è®¿", img: "images/s2_interview.gif", text: "åˆšåˆšè¡¨ç°å¾—æ€ä¹ˆæ ·å‘¢ï¼Ÿ" },
                { name: "ğŸ’ƒ ç»ƒè·³èˆ", img: "images/s2_dance.gif", text: "æ¯ä¸€ä¸ªåŠ¨ä½œéƒ½è¦åšåˆ°å®Œç¾ï¼ğŸ’ƒ" },
                { name: "ğŸ° ææ‹‰ç±³è‹", img: "images/s2_tiramisu.gif", text: "å¹¸ç¦çš„ç¬é—´~ğŸ˜—" }
            ]
        },
        {
            title: "Stage 3",
            levelUpText: "è§£é”æ–°æ­Œï¼šBOSS ğŸ˜",
            songId: "track-s3",
            idleImg: "images/s3_idle.gif",
            idleTexts: ["æ–°æ­ŒBOSSï¼Œå®å®ä»¬è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ", "ä½ ä»¬çš„ç¬‘å®¹ï¼Œå°±æ˜¯çƒ§çƒ§æ”¶åˆ°çš„æœ€æ£’çš„ç¤¼ç‰©å•¦ğŸ", "... (å‘†"],
            actions: [
                { name: "ğŸ¤ æˆ³æˆ³è„¸", img: "images/s3_poke.gif", text: "å“å‘€ï¼è¿™å¯æ˜¯å¦†å‘è€å¸ˆå¥½ä¸å®¹æ˜“å¼„å¥½çš„å‘å‹~~ï¼" },
                { name: "âœï¸ ç©ºæ°”ç­¾å", img: "images/s3_sign.gif", text: "ä¸­é—´æ˜¯å°çš‡å† ~ ğŸ‘‘" },
                { name: "ğŸŸ é…¸èœé±¼", img: "images/s3_fish.gif", text: "è™½ç„¶å¾ˆéš¾é€‰ ä½†é…¸èœé±¼æ˜¯æœ€å–œæ¬¢åƒçš„TOP1ï¼" }
            ]
        },
        {
            title: "Stage 4",
            levelUpText: "I'M BIGGER BADDER BETTER ğŸ˜",
            songId: "track-s4",
            idleImg: "images/s4_idle.gif",
            idleTexts: ["ä½ ä»¬çš„æ¯ä¸€æ¡æ¶ˆæ¯çƒ§çƒ§éƒ½åœ¨çœ‹å“¦ğŸ’ª", "ä»Šå¤©çš„çƒ§çƒ§æœ‰æ²¡æœ‰å¾ˆå¸…ï¼Ÿå¿«å¤¸æˆ‘ï¼ğŸ˜", "è°¢è°¢ä½ ä»¬ï¼Œè®©ä¸€åˆ‡å˜å¾—é‚£ä¹ˆæœ‰ä»·å€¼ğŸ©µ"],
            actions: [
                { name: "ğŸ«‚ æŠ±æŠ±", img: "images/s4_hug.gif", text: "æŠ±æŠ±ï¼è§åˆ°ä½ ä»¬çœŸçš„è¶…çº§å®‰å¿ƒğŸ©µ è¹­è¹­~" },
                { name: "ğŸ’¤ ç¡è§‰è§‰", img: "images/s4_sleep.gif", text: "ç¨å¾®ä¼‘æ¯ä¸€ä¸‹ä¸‹... æ¢¦é‡Œä¹Ÿè¦è§åˆ°å°å¤©ä½¿ä»¬...ğŸ’¤" },
                { name: "ğŸ’ åƒæ°´æœ", img: "images/s4_fruit.gif", text: "æ¥åƒæ°´æœï¼è¡¥å……ç»´C âœ¨" }
            ]
        },
        {
            title: "Stage 5",
            levelUpText: "å€’è®¡æ—¶ä¸‰ç§’æˆ‘åœä¸ä¸‹æ¥ ğŸ“¸",
            songId: "track-s5",
            idleImg: "images/s5_idle.gif",
            idleTexts: ["ä¸çŸ¥ä¸è§‰å°±ä¸€å‘¨å¹´å•¦ï¼ğŸ•°ï¸", "è¿™æ¬¡å›å½’è§äº†å¥½å¤šå¥½å¤šMAYniağŸ©µğŸ«³", "æœªæ¥ä¹Ÿè¦åœ¨ä¸€èµ·å“¦ï¼Œä¸€å‘¨å¹´å¿«ä¹ï¼ğŸ‰"],
            actions: [
                { name: "ğŸŒŸ å”±è·³èˆå°", img: "images/s5_stage.gif", text: "æ¯ä¸€æ¬¡èˆå°éƒ½æƒ³åšå¾—æ›´å¥½ï¼" },
                { name: "ğŸ† è·å¥–", img: "images/s5_award.gif", text: "è°¢è°¢ä½ ä»¬ï¼Œçƒ§çƒ§çˆ±ä½ ä»¬ğŸ¥º" },
                { name: "ğŸ‚ åƒè›‹ç³•", img: "images/cake_final.gif", text: "è¿™ä¸ªè›‹ç³•æ˜¯é€ç»™æˆ‘çš„å—ï¼ŸğŸ¥º è°¢è°¢ä¸€ç›´é™ªç€æˆ‘çš„ä½ ä»¬ï¼" }
            ]
        }
    ];

    let currentStage = 0;
    let clickCount = 0;
    let isInteracting = false;
    let isEvolving = false;
    let musicStarted = false;
    const charImg = document.getElementById('character');
    const stageTitle = document.getElementById('stage-title');
    const progressBar = document.getElementById('progress-bar');
    const controls = document.getElementById('controls');
    const gameBubble = document.getElementById('game-bubble');
    const centerNotify = document.getElementById('center-notification');

    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none'); 
        document.getElementById(id).style.display = 'flex'; 
        const musicCtrl = document.getElementById('global-music-control');
        musicCtrl.style.display = (id === 'start-screen') ? 'none' : 'block';
    }

    // --- éŸ³ä¹é€»è¾‘ (ä¿®æ”¹ç‰ˆï¼šè§£é”ä¸è‡ªåŠ¨åˆ‡æ­Œ) ---
    function initMusic() {
        if (!musicStarted) {
            playMusic('default');
            musicStarted = true;
        }
    }
    function playMusic(trackName, element) {
        if (element && element.classList.contains('locked')) return;
        const player = document.getElementById('bgm-player');
        player.src = `music/bgm_${trackName}.mp3`;
        player.play().catch(e => console.log("ç­‰å¾…äº¤äº’..."));
        document.querySelectorAll('.music-item').forEach(i => i.classList.remove('active'));
        if(element) element.classList.add('active');
        else if(trackName === 'default') document.querySelector('.music-item').classList.add('active');
        document.getElementById('music-menu').style.display = 'none';
    }
    function toggleMusicMenu() { const m = document.getElementById('music-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function unlockMusic(stageIdx) {
        const stageData = stages[stageIdx];
        if (stageData && stageData.songId) {
            const item = document.getElementById(stageData.songId);
            item.classList.remove('locked');
            item.innerText = item.innerText.replace('ğŸ”’', 'ğŸµ');
            // ä¿®æ”¹ï¼šè¿™é‡Œä¸å†è‡ªåŠ¨è°ƒç”¨ playMusic()
        }
    }
    function goHome() { showScreen('start-screen'); playMusic('default'); }
    function viewLetters() { initMusic(); showScreen('letters-list-screen'); loadLetters(); }

    // --- èŠå¤© ---
    let chatStep = 0;
    const chatScript = [
        { type: 'her', text: 'å®å®ï¼ï¼ä½ åœ¨å—ï¼Ÿï¼ğŸ˜±' },
        { type: 'her', text: 'å‘œå‘œå‘œï¼Œæˆ‘å¥½åƒè¢«å¸è¿›ä¸€ä¸ªåƒç´ ä¸–ç•Œäº†... ğŸ‘¾' },
        { type: 'her', text: 'è¿™é‡Œæœ‰ä¸ªå£°éŸ³è¯´ï¼Œåªæœ‰ä½ æ¥å½“PDè¿›è¡Œå…»æˆæ‰èƒ½å¸¦æˆ‘é€šå…³ï¼' },
        { type: 'her', text: 'ä½ éœ€è¦é€šè¿‡ã€æ‘¸æ‘¸ã€‘å’Œã€æŠ•å–‚ã€‘æ¥å¢åŠ é¡¶éƒ¨çš„çˆ±å¿ƒå€¼ğŸ’—' },
        { type: 'her', text: 'å“¦å¯¹äº†ï¼ç›´æ¥ç‚¹å‡»æˆ‘ä¹Ÿå¯ä»¥å¢åŠ çˆ±å¿ƒå“¦ï¼ğŸ’–' },
        { type: 'her', text: 'å³ä¸Šè§’å¯ä»¥åˆ‡æ¢BGMï¼Œä¸æ¢çš„è¯å°±æ˜¯é»˜è®¤éŸ³ä¹ä¸€ç›´é™ªç€ä½ ~ğŸµ' },
        { type: 'her', text: 'å¬è¯´æœ€åè¿˜æœ‰éšè—æƒŠå–œ... ğŸ' },
        { type: 'her', text: 'æ€ä¹ˆæ ·ï¼Ÿæ„¿æ„å¸®å¸®çƒ§çƒ§å—ï¼ŸğŸ¥º' }
    ];
    function startChat() { initMusic(); showScreen('chat-screen'); document.getElementById('contact-list').style.display = 'block'; document.getElementById('chat-content').style.display = 'none'; document.getElementById('chat-options').style.display = 'none'; chatStep = 0; }
    function openChat() { document.getElementById('contact-list').style.display = 'none'; document.getElementById('chat-content').style.display = 'flex'; playChatScript(); }
    function playChatScript() {
        if (chatStep < chatScript.length) {
            const msg = chatScript[chatStep];
            addMsg(msg.type, msg.text);
            chatStep++;
            setTimeout(playChatScript, 1200);
        } else { document.getElementById('chat-options').style.display = 'flex'; }
    }
    function addMsg(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        const avatarHtml = type === 'her' ? `<img src="images/avatar_miche.jpg" style="width:35px;height:35px;border-radius:10px;margin-right:10px;" onerror="this.src='https://via.placeholder.com/35'">` : '';
        div.innerHTML = `${avatarHtml}<div class="bubble">${text}</div>`;
        const content = document.getElementById('chat-content');
        content.appendChild(div); content.scrollTop = content.scrollHeight;
    }
    function handleChatChoice(agree) {
        document.getElementById('chat-options').style.display = 'none';
        if (agree) {
            addMsg('me', 'å¥½ï¼å¼€å§‹å§ï¼æ”¾å¿ƒäº¤ç»™æˆ‘ï¼');
            setTimeout(() => { addMsg('her', 'å¤ªæ£’å•¦ï¼æœ€çˆ±ä½ äº†ğŸ©µ é‚£æˆ‘ä»¬å¼€å§‹å’¯ï¼'); setTimeout(startGame, 2000); }, 1000);
        } else {
            addMsg('me', 'å•Šâ€¦â€¦æˆ‘ä¸å¹²â€¦â€¦');
            setTimeout(() => { addMsg('her', 'çœŸçš„å—ï¼ŸğŸ¥º'); addMsg('her', 'çœŸçš„è¦ä¸¢ä¸‹çƒ§çƒ§å—ï¼ŸğŸ˜­ğŸ˜­ğŸ˜­'); setTimeout(() => { document.getElementById('chat-options').style.display = 'flex'; }, 1500); }, 1000);
        }
    }

    // --- æ¸¸æˆä¸»é€»è¾‘ ---
    function startGame() {
        showScreen('game-screen');
        currentStage = 0; isInteracting = false; isEvolving = false;
        updateStageDisplay();
        charImg.onclick = () => {
            if (isInteracting || isEvolving) return;
            const texts = stages[currentStage].idleTexts;
            showBubble(texts[Math.floor(Math.random() * texts.length)]);
            addProgress();
        };
    }
    function updateStageDisplay() {
        const stageData = stages[currentStage];
        stageTitle.innerText = stageData.title;
        charImg.src = stageData.idleImg;
        controls.innerHTML = '';
        stageData.actions.forEach((action) => {
            const btn = document.createElement('button');
            btn.className = 'game-btn'; btn.innerText = action.name;
            btn.onclick = () => handleAction(action);
            controls.appendChild(btn);
        });
        clickCount = 0; updateProgressBar();
    }
    function handleAction(action) {
        if (isInteracting || isEvolving) return;
        isInteracting = true;
        charImg.src = action.img;
        showBubble(action.text);
        setTimeout(() => { charImg.src = stages[currentStage].idleImg; isInteracting = false; }, 3000);
        addProgress();
    }
    function addProgress() {
        if (isEvolving) return;
        if (clickCount < CLICK_TARGET) {
            clickCount++;
            updateProgressBar();
            if (clickCount >= CLICK_TARGET) {
                if (currentStage < stages.length - 1) setTimeout(startEvolution, 500);
                else setTimeout(startEndingSequence, 500);
            }
        }
    }
    function updateProgressBar() { const percentage = (clickCount / CLICK_TARGET) * 100; progressBar.style.width = Math.min(percentage, 100) + '%'; }
    function startEvolution() {
        isEvolving = true;
        showCenterNotify("å’¦... å¥½åƒå‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–...âœ¨", 2000);
        setTimeout(() => { charImg.classList.add('evolving'); }, 1000);
        setTimeout(() => {
            currentStage++;
            unlockMusic(currentStage); // ä»…è§£é”ä¸æ’­æ”¾
            updateStageDisplay();
            charImg.classList.remove('evolving');
            const nextStageData = stages[currentStage];
            showCenterNotify(`âœ¨ ${nextStageData.levelUpText} âœ¨`, 3000);
            isEvolving = false;
        }, 3000);
    }
    function startEndingSequence() {
        isEvolving = true;
        const stageData = stages[currentStage];
        showCenterNotify(`âœ¨ ${stageData.levelUpText} âœ¨`, 3000);
        setTimeout(() => { showScreen('editor-screen'); }, 3000);
    }
    function showBubble(text) { gameBubble.innerText = text; gameBubble.style.opacity = 1; setTimeout(() => { gameBubble.style.opacity = 0; }, 2500); }
    function showCenterNotify(htmlText, duration) {
        centerNotify.innerHTML = htmlText; centerNotify.style.display = 'block';
        setTimeout(() => { centerNotify.style.opacity = 1; }, 10);
        setTimeout(() => { centerNotify.style.opacity = 0; setTimeout(() => { centerNotify.style.display = 'none'; }, 300); }, duration);
    }

    // --- æœ€ç»ˆç»“å±€ (ç‚¹å‡»è§¦å‘ç‰ˆ) ---
    let endingItemsDropped = false;

    function runEndingSequence() {
        const text = document.getElementById('wish-input').value;
        if (!text) return alert("å†™ç‚¹ä»€ä¹ˆå§~");
        const savedLetters = JSON.parse(localStorage.getItem('miche_letters') || '[]');
        savedLetters.push({ content: text, date: new Date().toLocaleDateString() });
        localStorage.setItem('miche_letters', JSON.stringify(savedLetters));

        showScreen('ending-table-screen');
        const container = document.getElementById('table-items-container');
        container.innerHTML = '';
        endingItemsDropped = false;
        document.getElementById('click-hint-arrow').style.display = 'none';
        document.getElementById('ending-blur-layer').classList.remove('blur-active');
        document.getElementById('final-text-container').style.opacity = 0;

        const items = [
            { type: 'div', class: 'final-envelope', css: 'left: 30%; top: 30%; background: #87CEEB; transform: rotate(-10deg);', delay: 500 },
            { type: 'img', src: 'images/s1_idle.gif', class: 'final-sticker', css: 'left: 60%; top: 20%; transform: rotate(15deg);', delay: 1500 },
            { type: 'img', src: 'images/s5_idle.gif', class: 'final-sticker', css: 'left: 20%; top: 60%; transform: rotate(-20deg);', delay: 2500 },
            { type: 'polaroid', src: 'images/polaroid_cake.jpg', css: 'left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(5deg);', delay: 3500 }
        ];

        let maxDelay = 0;
        items.forEach(item => {
            if(item.delay > maxDelay) maxDelay = item.delay;
            setTimeout(() => {
                let el;
                if (item.type === 'polaroid') {
                    el = document.createElement('div');
                    el.className = 'table-item final-polaroid drop';
                    el.innerHTML = `<img src="${item.src}"><div style="font-size:0.8em; color:#555; margin-top:5px;">Happy 1st Anniversary</div>`;
                } else if (item.type === 'img') {
                    el = document.createElement('img');
                    el.src = item.src; el.className = 'table-item final-sticker drop';
                } else {
                    el = document.createElement('div'); el.className = `table-item ${item.class} drop`;
                }
                const rotation = item.css.match(/rotate\((.*?)\)/)[1];
                el.style.cssText += item.css;
                el.style.setProperty('--r', rotation);
                container.appendChild(el);
            }, item.delay);
        });

        // æ‰è½å®Œæˆåï¼Œæ˜¾ç¤ºæç¤ºç®­å¤´ï¼Œå¹¶å…è®¸ç‚¹å‡»
        setTimeout(() => {
            endingItemsDropped = true;
            document.getElementById('click-hint-arrow').style.display = 'block';
        }, maxDelay + 1000);
    }

    function triggerFinalReveal() {
        if (!endingItemsDropped) return; // è¿˜æ²¡æ‰å®Œä¸è®¸ç‚¹
        endingItemsDropped = false; // é˜²æ­¢é‡å¤ç‚¹
        document.getElementById('click-hint-arrow').style.display = 'none';
        document.getElementById('ending-blur-layer').classList.add('blur-active');
        document.getElementById('final-text-container').style.opacity = 1;
        // è¿™é‡Œå¯ä»¥å†æ”¾ä¸€ç‚¹ç¤¼èŠ±æ•ˆæœ
    }
    
    function loadLetters() {
        const container = document.getElementById('letters-container');
        container.innerHTML = '';
        const savedLetters = JSON.parse(localStorage.getItem('miche_letters') || '[]');
        if (savedLetters.length === 0) { container.innerHTML = '<p style="text-align:center; color:gray;">è¿˜æ²¡æœ‰ä¿¡ä»¶å“¦~</p>'; }
        else { savedLetters.reverse().forEach(l => { container.innerHTML += `<div style="background:white;padding:15px;margin-bottom:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);">${l.content}<div style="font-size:0.8em;color:gray;margin-top:5px;">${l.date}</div></div>`; }); }
    }
</script>
</body>
</html>